<!DOCTYPE html>
<html lang="da">
<head>
  <link rel="stylesheet" href="/forside.css">
  <meta charset="UTF-8" />
  <title>Forsiden</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="logo-box">Understory</div>

        <nav>
          <div class="nav-section">
            <div class="nav-item">
              <span><a href="/forside" style="text-decoration: none; color: inherit;">Hjem</a></span>
            </div>
            <div class="nav-item">
              <span>Kalender</span>
            </div>
            <div class="nav-item active">
              <span>Oplevelser</span>
            </div>
            <div class="nav-item">
              <span><a href="/search" style="text-decoration: none; color: inherit;">S√∏g</a></span>
            </div>
            <div class="nav-item">
              <span>Salg</span>
            </div>
          </div>

          <div class="nav-item-group-title">Storefront</div>
          <div class="nav-section">
            <div class="nav-item">
              <span>Storefront</span>
            </div>
            <div class="nav-item">
              <span>Grow</span>
            </div>
          </div>
          
          <div class="nav-item-group-title" style="margin-top: 32px;">Konto</div>
          <div class="nav-section">
            <div class="nav-item">
              <span id="user-name">Indl√¶ser...</span>
            </div>
            <div class="nav-item" style="cursor: pointer;" id="logout-btn">
              <span>Log ud</span>
            </div>
          </div>
        </nav>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main">
      <div class="main-header">
        <h1 class="title">Oplevelser</h1>
        <!-- eneste interaktive element -->
        <button class="primary-btn" id="oplevelserknap">+ Oplevelse</button>
      </div>

      <div class="filters">
        <button class="filter-pill active">Live</button>
        <button class="filter-pill">Arkiveret</button>
      </div>

            <!-- Container til dynamiske events - bruger samme experience-card stil -->
      <div id="events-container">
        <button style="text-align: center; padding: 40px; color: #6b7280; cursor: pointer;" id="loading-message">
          Henter oplevelser...
        </button>
    </main>
  </div>

  <script>
    // Hent bruger info og vis i sidebar
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/auth/me');
        const result = await response.json();
        
        if (result.success) {
          console.log('‚úÖ Bruger er logget ind:', result.host.navn);
          const userNameElement = document.getElementById('user-name');
          if (userNameElement) {
            userNameElement.textContent = result.host.navn;
          }
        } else {
          console.log('‚ùå Bruger er ikke logget ind - redirecter til login');
          window.location.href = '/';
        }
      } catch (error) {
        console.log('‚ùå Fejl ved tjek af login - redirecter til login');
        window.location.href = '/';
      }
    }
    
    // Logout funktion
    async function logout() {
      try {
        console.log('üîÑ Logger ud...');
        const response = await fetch('/api/auth/logout', {
          method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
          console.log('‚úÖ Logout succesfuldt! Cookies er slettet p√• serveren');
          window.location.href = '/';
        }
      } catch (error) {
        console.error('Fejl ved logout:', error);
      }
    }
    
    // Event listener for logout knap og load events
    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      }
      loadUserInfo();
      loadEvents();
    });
    
    // Hent events fra API n√•r siden loader
    async function loadEvents() {
      const container = document.getElementById('events-container');
      const loadingMessage = document.getElementById('loading-message');
      
      try {
        // Hent logget ind v√¶rt's events (fra cookie)
        // F√∏rst tjek om bruger er logget ind
        const authResponse = await fetch('/api/auth/me');
        const authResult = await authResponse.json();
        
        if (!authResult.success) {
          // Hvis ikke logget ind, redirect til login
          window.location.href = '/';
          return;
        }
        
        const loggedInHost = authResult.host.navn;
        const response = await fetch('/services/hostEvents?host=' + loggedInHost);
        const hostDataClient = await response.json();
        console.log("************HostDataClient********");
        console.log(hostDataClient);
        //console.log("************HostDataClient.events********");
        //console.log(hostDataClient.data);
        
        if (hostDataClient.success && hostDataClient.data) {
          // Vis alle events fra alle v√¶rter
          displayEvents(hostDataClient.data);
        
        } else {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;">Kunne ikke hente oplevelser: ' + (hostDataClient.error || 'Ukendt fejl') + '</div>';
        }
      } catch (error) {
        if (loadingMessage) loadingMessage.remove();
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;">Der opstod en fejl ved hentning af data: ' + error.message + '</div>';
      }
    }

    // Vis events i UI - bruger samme experience-card struktur
    function displayEvents(hosts) {
      //console.log("*******Hosts********");
      //console.log(hosts);
      const container = document.getElementById('events-container');
      
        if (!hosts || hosts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">Ingen oplevelser fundet</div>';
        return;
      }

      // T√∏m container f√∏rst
      container.innerHTML = '';


      console.log("******displayEvents Hosts*****");
      console.log(hosts);

      console.log("******displayEvents Events*****");
      console.log(hosts.events[0]);

      console.log("******displayEvents Event nummer 0*****");
      console.log(hosts.events[0][0]);


      let antalEvents = hosts.events[0].length

      console.log("Antal events i tal");
      console.log(antalEvents);

      // Loop gennem alle hosts
      for (let i = 0; i < antalEvents; i++) {
        const event = hosts.events[0][i];
        console.log("*******Host********");
        console.log(event);
        
        // Hent event data direkte
        const eventData = event
        console.log("*******Host.event********");
        console.log(eventData);

        console.log(eventData.titel);
        
        // Start med standard v√¶rdier
        let titel = 'Ingen titel angivet';
        let subtitle = 'Standardoplevelse';
        
        // Hvis vi har event data med en titel, brug den
        if (eventData && eventData.titel) {
          // S√¶t titlen til event data titlen
          titel = eventData.titel;
          
          // Byg beskrivelsen op stykke for stykke
          let beskrivelseTekst = '';
          
          // Tilf√∏j beskrivelse hvis den findes
          if (eventData.beskrivelse) {
            beskrivelseTekst = eventData.beskrivelse;
          }
          
          // Tilf√∏j dato og tid hvis de findes
          if (eventData.dato && eventData.tid) {
            if (beskrivelseTekst) {
              beskrivelseTekst += ' ‚Ä¢ ';  // Tilf√∏j separator hvis der allerede er tekst
            }
            beskrivelseTekst += `${eventData.dato} kl. ${eventData.tid}`;
          }
        
          // Brug den byggede beskrivelse, eller standard hvis den er tom
          subtitle = beskrivelseTekst || 'Standardoplevelse';
          
          } else {
            // Hvis vi ikke har event data, brug v√¶rt information i stedet
            titel = `${hosts.kategori || 'Oplevelse'} hos ${hosts.source}`;
            subtitle = `Lokation: ${hosts.lokation}`;
          }
        
        // Opret experience-card -
        const card = document.createElement('section');
        card.className = 'experience-card';
        card.dataset.id = hosts.id;
        card.style.cursor = "pointer";
        
        // Generer HTML 
        card.innerHTML = `
        <div class="experience-image">
          <div class="draft-badge">${eventData.kategori || 'Oplevelse'}</div>
        </div>
        <div class="experience-content">
          <div class="experience-title">${titel}</div>
          <div class="experience-subtitle">${subtitle}</div>
        </div>
        `;
      
        //console.log("*******check data Inden vi opretter eventlistner********");
        //console.log(eventData);
        //console.log(eventData.id);

        card.addEventListener("click", () => {
          //window.location.href = ("/oplevelser");

          console.log("*******Check event.id inden den bliver sendt videre til oplevelser.html********");
          console.log(eventData.id);

          let clickedEvent = eventData.id;
          window.location.href = `/oplevelser?event=${clickedEvent}`;
        });  

        container.appendChild(card);
      }
    }

  </script>
</body>
</html>