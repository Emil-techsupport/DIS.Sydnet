<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samarbejd - Sydnet</title>
    <link rel="stylesheet" href="/forside.css">
    <link rel="stylesheet" href="/besked.css">
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-top">
              <div class="logo-box">Understory</div>
      
              <nav>
                <div class="nav-section">
                    <div class="nav-item">
                        <span><a href="/forside" style="text-decoration: none; color: inherit;">Hjem</a></span>
                    </div>
                  <div class="nav-item">
                    <span>Kalender</span>
                  </div>
                  <div class="nav-item">
                    <span><a href="/forside" style="text-decoration: none; color: inherit;">Oplevelser</a></span>
                 </div>
                 <div class="nav-item">
                    <span><a href="/search" style="text-decoration: none; color: inherit;">Find samarbejde</a></span>
                 </div>
                </div>
      
                <div class="nav-item-group-title">Storefront</div>
                <div class="nav-section">
                  <div class="nav-item">
                    <span>Storefront</span>
                  </div>
                  <div class="nav-item">
                    <span>Grow</span>
                  </div>
                </div>
                <div class="nav-item-group-title" style="margin-top: 32px;">Konto</div>
                <div class="nav-section">
                    <div class="nav-item" style="cursor: pointer;" id="logout-btn">
                    <span>Log ud</span>
                    </div>
                </div>
              </nav>
            </div>
          </aside>
      
        <!-- Main Content -->
        <main class="main">
            <div class="main-header">
                <h1 class="title">Samarbejd med andre oplevelser</h1>
            </div>

            <div class="main-content">
                <!-- Event Information -->
                <div id="event-info" class="experience-card">
                </div>

                <!-- Message Form -->
                <div class="message-section">
                    <h3>Send besked til værten</h3>
                    <form id="message-form" class="message-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sender-name">Dit navn</label>
                                <input type="text" id="sender-name" name="senderName" required 
                                       placeholder="Indtast dit navn">
                            </div>
                            
                            <div class="form-group">
                                <label for="sender-phone">Dit telefonnummer</label>
                                <input type="tel" id="sender-phone" name="senderPhone" required 
                                       placeholder="12 34 56 78">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="message-text">Besked til værten</label>
                            <textarea id="message-text" name="messageText" required 
                                      placeholder="Hej! Jeg vil gerne samarbejde med dig. Jeg afholder et event der ville passe perfekt til at slå sammen med dit!"></textarea>
                        </div>
                        
                        <button type="submit" class="cta-button">Send besked</button>
                    </form>
                </div>

                <!-- Success/Error Messages -->
                <div id="message-status" class="message-status" style="display: none;">
                    <!-- Status beskeder vises her -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // Globale variabler
        let currentEventData = null;

        // Hent event-data fra URL, vi henter det data vi genere fra search og laver det til json, så vi kan arbejde med det 
        function hentEventDataFraURL() {
            // Hent URL parametre
            const urlParams = new URLSearchParams(window.location.search);
            const eventDataString = urlParams.get('event');
            
            if (eventDataString) {
                try {
                    // Konverter URL-data tilbage til objekt
                    const eventData = JSON.parse(decodeURIComponent(eventDataString));
                    return eventData; // event information
                } catch (error) {
                    console.error('Fejl ved parsing af event-data:', error);
                    return null;
                }
            }
            return null;
        }

        // Hent events fra API hvis der ikke er URL parametre
        async function hentEventsFraAPI() {
            try {
                // Tjek om bruger er logget ind
                const authResponse = await fetch('/api/auth/me', {
                  credentials: 'include' // Hvis ikke logget ind -> send til login siden
                });
                const authResult = await authResponse.json();
                
                if (!authResult.success) {
                    return null;
                }
                
                // Find en anden vært end den logget ind (hvis Anna er logget ind, vis Tim's events)
                const loggedInHost = authResult.host.navn;
                const searchHost = loggedInHost === 'Anna' ? 'Tim' : 'Anna';
                
                const response = await fetch('/services/hostEvents?host=' + searchHost);
                const result = await response.json();
                
                if (result && result.success && result.data) {
                    const hostData = result.data;
                    
                    if (hostData.events && Array.isArray(hostData.events) && hostData.events.length > 0) {
                        const firstEvent = hostData.events[0][0];
                        
                        return {
                            source: hostData.navn,
                            kategori: firstEvent.kategori || 'Ukendt',
                            lokation: hostData.lokation,
                            data: {
                                title: firstEvent.titel,
                                beskrivelse: firstEvent.beskrivelse,
                                dato: firstEvent.dato,
                                tid: firstEvent.tidspunkt,
                                varighed: firstEvent.varighed,
                                pris: firstEvent.pris
                            }
                        };
                    }
                }
                return null;
            } catch (error) {
                console.error('Fejl ved hentning af events:', error);
                return null;
            }
        }

        // Vis event information
        function visEventInfo(eventData) {
            const container = document.getElementById('event-info');
            
            if (!eventData) {
                container.innerHTML = '<p>Ingen event-data fundet.</p>';
                return;
            }

            // Gem event-data globalt
            currentEventData = eventData;
            
            // Byg HTML-indhold til event-kortet
            
            // Først lav vi titel og vært-info
            const titel = eventData.data?.title || `${eventData.kategori} hos ${eventData.source}`;
            const værtInfo = `Vært: ${eventData.source} • ${eventData.lokation}`;
            
            // Lav beskrivelse hvis den findes
            let beskrivelse = '';
            if (eventData.data?.beskrivelse) {
                beskrivelse = `<p class="experience-description">${eventData.data.beskrivelse}</p>`;
            }
            
            // Lav detaljer - kun vis dem der findes
            let detaljer = '';
            
            if (eventData.data?.dato) {
                detaljer += `
                    <div class="detail-item">
                        <strong>Dato</strong>
                        <span>${eventData.data.dato}</span>
                    </div>`;
            }
            
            if (eventData.data?.tid) {
                detaljer += `
                    <div class="detail-item">
                        <strong>Tid</strong>
                        <span>${eventData.data.tid}</span>
                    </div>`;
            }
            
            if (eventData.data?.varighed) {
                detaljer += `
                    <div class="detail-item">
                        <strong>Varighed</strong>
                        <span>${eventData.data.varighed}</span>
                    </div>`;
            }
            
            if (eventData.data?.pris) {
                detaljer += `
                    <div class="detail-item">
                        <strong>Pris</strong>
                        <span>${eventData.data.pris} kr.</span>
                    </div>`;
            }
            
            // Kategori vises altid
            detaljer += `
                <div class="detail-item">
                    <strong>Kategori</strong>
                    <span>${eventData.kategori}</span>
                </div>`;
            
            // Sæt alt sammen til færdigt HTML
            const eventHTML = `
                <div class="experience-header">
                    <h3 class="experience-title">${titel}</h3>
                    <div class="experience-host">${værtInfo}</div>
                </div>
                
                ${beskrivelse}
                
                <div class="experience-details">
                    ${detaljer}
                </div>
            `;
            
            container.innerHTML = eventHTML;
        }

        // Håndter besked-formular
        function haandterBeskedFormular() {
            const form = document.getElementById('message-form');
        // Vært A udfylder formular med besked til vært B 
            form.addEventListener('submit', async function(e) {
                // Stop normal form submission
                e.preventDefault(); // stopper normal form submission
                
                // Hent form-data
                const senderName = document.getElementById('sender-name').value.trim(); // sender navn
                const senderPhone = document.getElementById('sender-phone').value.trim(); // sender telefonnummer
                const messageText = document.getElementById('message-text').value.trim(); // sender besked
                
                // Valider data så man kun kan sende besked hvis alle felter er udfyldt
                if (!senderName || !senderPhone || !messageText) {
                    visBesked('Udfyld venligst alle felter.', 'error');
                    return;
                }
                // Tjek om der er event-data så man kun kan sende besked hvis der er event-data
                if (!currentEventData) {
                    visBesked('Ingen event-data fundet.', 'error');
                    return;
                }
                
                // Forbered besked-data, dette er skabelon for at sende beskeden til vært B
                const beskedData = {
                    senderName: senderName,
                    senderPhone: senderPhone,
                    messageText: messageText,
                    // Event-info er skabelon for at sende beskeden til vært B
                    eventInfo: {
                        title: currentEventData.data?.title || `${currentEventData.kategori} hos ${currentEventData.source}`,
                        host: currentEventData.source,
                        location: currentEventData.lokation,
                        category: currentEventData.kategori
                    },
                    timestamp: new Date().toISOString()
                };
                console.log("****Besked data event info host****");
                console.log(beskedData.eventInfo.host)
                try {
                    // Simuler afsendelse (i virkeligheden ville dette gå til en server)
                    await sendBesked(beskedData);
                    
                    // Vis success besked
                    visBesked(`Besked sendt til ${currentEventData.source}! De vil kontakte dig på ${senderPhone}.`, 'success');
                    
                    // Nulstil formular, ellers virker det ikke med at sende beskeden igen
                    form.reset();
                    
                } catch (error) {
                    console.error('Fejl ved afsendelse af besked:', error);
                    visBesked('Der opstod en fejl. Prøv igen senere.', 'error');
                }
            });
        }

        // Send besked via Twilio SMS - frontend side sender beskeden til server side som håndterer Twilio (twilio.js)
        async function sendBesked(beskedData) {
            try {
                // Send besked til server som håndterer Twilio (twilio.js)
                const response = await fetch('/api/kollab/send-sms', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        xTwilioWebhookEnabled: true
                    },
                    body: JSON.stringify(beskedData)
                });
                
                const result = await response.json();
                console.log("*****Result******");
                console.log(result);
                
                if (!result.success) {
                    throw new Error(result.message || 'SMS kunne ikke sendes');
                }
                
                console.log('SMS sendt via Twilio:', result); // dette er kun til debugging ofc :))
                return result;
                
            } catch (error) {
                console.error('Fejl ved SMS-afsendelse:', error);
                throw error;
            }
        }

        // Vis status-besked altså når beskeden er sendt viser vi en besked til brugeren om at beskeden er sendt
        function visBesked(tekst, type) {
            // Hent status-container så vi kan sætte teksten og CSS-klassen på den
            const statusContainer = document.getElementById('message-status');
            
            // Sæt CSS-klasse så det ser nice 
            // type er success eller error så vi kan sætte CSS-klassen på den
            statusContainer.className = `message-status ${type}`;
            statusContainer.textContent = tekst;
            // Vis beskeden 
            statusContainer.style.display = 'block';
            
            // Skjul besked efter 5 sekunder så den ikke står der for evigt :(
            setTimeout(() => {
                statusContainer.style.display = 'none';
            }, 5000);
        }

        // Tjek om bruger er logget ind
        async function checkLogin() {
            try {
                const response = await fetch('/api/auth/me', {
                  credentials: 'include'
                });
                const result = await response.json();
                
                if (!result.success) {
                    window.location.href = '/';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = '/';
                return false;
            }
        }

        // Initialiser siden når DOM er klar
        async function initialiserSide() {
            // Tjek om bruger er logget ind først
            const isLoggedIn = await checkLogin();
            if (!isLoggedIn) {
                return;
            }
            
            // Hent og vis event-data
            let eventData = hentEventDataFraURL();
            
            // Hvis der ikke er data fra URL, hent fra API
            if (!eventData) {
                eventData = await hentEventsFraAPI();
            }
            
            visEventInfo(eventData);
            
            // Sæt event-listeners op
            haandterBeskedFormular();
        }

        // Start når siden er loadet
        window.addEventListener('DOMContentLoaded', initialiserSide);

        // Logout funktion
        async function logout() {
        try {
            const response = await fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
            });
            const result = await response.json();
            
            if (result.success) {
            window.location.href = '/';
            }
        } catch (error) {
            console.error('Fejl ved logout:', error);
        }
        }
        
        // Load events når siden loader
        window.addEventListener('DOMContentLoaded', function() {
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
        }
        //loadAllEvents();
    });
    </script>

    
</body>
</html>
