<!DOCTYPE html>
<html lang="da">
<head>
  <link rel="stylesheet" href="/search.css">
  <meta charset="UTF-8" />
  <title>Søg Oplevelser - Samarbejde</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="logo-box">Understory</div>

        <nav>
          <div class="nav-section">
            <div class="nav-item">
              <span><a href="/forside" style="text-decoration: none; color: inherit;">Hjem</a></span>
            </div>
            <div class="nav-item">
              <span>Kalender</span>
            </div>
            <div class="nav-item">
              <span><a href="/forside" style="text-decoration: none; color: inherit;">Oplevelser</a></span>
            </div>
            <div class="nav-item active">
              <span>Find samarbejde</span>
            </div>
            <div class="nav-item">
              <span>Salg</span>
            </div>
          </div>

          <div class="nav-item-group-title">Storefront</div>
          <div class="nav-section">
            <div class="nav-item">
              <span>Storefront</span>
            </div>
            <div class="nav-item">
              <span>Grow</span>
            </div>
          </div>
          
          <div class="nav-item-group-title" style="margin-top: 32px;">Konto</div>
          <div class="nav-section">
            <div class="nav-item" style="cursor: pointer;" id="logout-btn">
              <span>Log ud</span>
            </div>
          </div>
        </nav>
      </div>
    </aside>
    <!-- Main content -->
    <main class="main">
      <div class="main-header">
        <h1 class="title">Søg efter events at samarbejde med her</h1>
        <p style="font-size: 16px; margin-top: 8px;">
          Find andre oplevelser og start samarbejde med andre værter
        </p>
      </div>

      <div class="second-header">
        <div class="samarbejdeEvent">Du er lige nu i gang med at finde et samarbejde for dette af dine events:</div>
        <div class ="eventinfo" id="eventInfo"></div>
      </div>

      <!-- Søge container -->
      <div class="search-container">
        <input 
          type="text" 
          id="search-input" 
          class="search-box" 
          placeholder="Søg efter oplevelser, værter, kategorier..."
          autocomplete="off"
        />
        
        <div class="filters-row">
          <select id="category-filter" class="filter-select">
            <option value="">Alle kategorier</option>
            <option value="Health & Yoga">Health & Yoga</option>
            <option value="Food & Tastings">Food & Tastings</option>
            <option value="Wellness & Spa">Wellness & Spa</option>
            <option value="Adventure & Activities">Adventure & Activities</option>
          </select>
          
          <select id="location-filter" class="filter-select">
            <option value="">Alle lokationer</option>
            <option value="København">København</option>
            <option value="Aarhus">Aarhus</option>
            <option value="Odense">Odense</option>
            <option value="Helsingør">Helsingør</option>
            <option value="Helsingør">Hillerød</option>
          </select>
        </div>
        
        <div class="search-stats" id="search-stats" style="display: none;">
          Fundet <strong id="result-count">0</strong> oplevelser
        </div>
      </div>

      <!-- Søgeresultater -->
      <div id="search-results" class="search-results">
        <div class="no-results">
          <p>Indtast en søgning for at finde oplevelser</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    let allEvents = []; // Gemmer alle events
    
    // Hent alle events når siden loader
    async function loadAllEvents() {
      try {
        // Tjek om bruger er logget ind
        const brugerTjek = await fetch('/api/auth/me', {
          credentials: 'include'
        });
        const brugerTjekResultat = await brugerTjek.json();
        
        //Hvis brugeren ikke er logget ind, så send ham til log ind siden
        if (!brugerTjekResultat.success) {
          window.location.href = '/login';
          return;
        }
        
        // Find navn på vært der er logget ind
        const loggetIndHost = brugerTjekResultat.host.navn;
        // Find en anden vært end den logget ind (hvis Anna er logget ind, vis Tim's events)
        let samarbejdeHost;
        if (loggetIndHost === "Anna") {
          samarbejdeHost = "Tim";
        } else {
          samarbejdeHost = "Anna";
        }
        
        //Find alle events som "samarbejdeHost" har(Modsat host af den som er logget ind)
        const response = await fetch('/services/hostEvents?host=' + samarbejdeHost);
        const HostOgEventData = await response.json();

        //console.log("*******Events for host der ikke er logget ind******");
        //console.log(HostOgEventData);


        const params = new URLSearchParams(window.location.search);
        const clickedEventId = params.get("eventID");

        console.log("********ClickedEvent.ID*********")
        console.log(clickedEventId);


        //Hvis det gik godt med at hente "samarbejdeHost"s events
        if (HostOgEventData.success && HostOgEventData.data) {
          const hostData = HostOgEventData.data;
          const eventsArray = hostData.events[0];
          allEvents = [];
          console.log("*******Host data******");
          console.log(hostData);
          
          // Loop gennem events og konverter dem
          for (let i = 0; i < eventsArray.length; i++) {
            const event = eventsArray[i];
            
            allEvents.push({
              source: hostData.navn,
              kategori: event.kategori,
              lokation: event.lokation,
              data: {
                title: event.titel,
                beskrivelse: event.beskrivelse,
                dato: event.dato,
                tid: event.tidspunkt,
                varighed: event.varighed,
                pris: event.pris
              }
            });
          }
          displayResults(allEvents);
        }
      } catch (error) {
        document.getElementById('search-results').innerHTML = 
          '<div class="no-results">Kunne ikke hente oplevelser.</div>';
      }
    }
    
    // Søge funktion
    function searchEvents() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
      const categoryFilter = document.getElementById('category-filter').value;
      const locationFilter = document.getElementById('location-filter').value;
      
      let filtered = allEvents;
      
      // Filtrer efter søgeterm
      if (searchTerm) {
        filtered = filtered.filter(event => {
          const title = event.data?.title?.toLowerCase() || '';
          const beskrivelse = event.data?.beskrivelse?.toLowerCase() || '';
          const source = event.source?.toLowerCase() || '';
          const kategori = event.kategori?.toLowerCase() || '';
          
        if (title.includes(searchTerm)) return true; 
        if (beskrivelse.includes(searchTerm)) return true;
        if (source.includes(searchTerm)) return true;
        if (kategori.includes(searchTerm)) return true;
        return false;
      });
    };
      // Filtrer efter kategori
      if (categoryFilter) {
        filtered = filtered.filter(event => event.kategori === categoryFilter);
      }
      
      // Filtrer efter lokation
      if (locationFilter) {
        filtered = filtered.filter(event => event.lokation === locationFilter);
      }
      
      displayResults(filtered);
    }
    
    // Vis søgeresultater
    function displayResults(filteredEvents) {
      const container = document.getElementById('search-results');
      const statsDiv = document.getElementById('search-stats');
      const countSpan = document.getElementById('result-count');
      
      // Tjek hvor mange resultater vi har
      const antalResultater = filteredEvents.length;
      const søgeTekst = document.getElementById('search-input').value.trim();
      const harSøgt = søgeTekst.length > 0;
      
      // Vis statistik hvis brugeren har søgt eller der er resultater
      if (antalResultater > 0 || harSøgt) {
        statsDiv.style.display = 'block';  // Vis statistik
        countSpan.textContent = antalResultater;  // Opdater antal
      } else {
        statsDiv.style.display = 'none';  // Skjul statistik
      }
      
      // Hvis ingen resultater fundet, vis besked og stop
      if (antalResultater === 0) {
        container.innerHTML = '<div class="no-results">Ingen oplevelser fundet. Prøv at ændre dine søgekriterier.</div>';
        return;  // Stop funktionen her
      }
      
      container.innerHTML = '';

      // går igennem hver eneste event og genererer en card for hver event
      filteredEvents.forEach(event => {
        console.log("*****Event data(I for loop)****");
        console.log(event);
        const eventData = event.data;
        const card = document.createElement('div');
        card.className = 'result-card';
    
        card.innerHTML = `
          <div class="result-header">
            <div style="flex: 1;">
              <div class="result-title">${eventData?.title || `${event.kategori} hos ${event.source}`}</div>
              <div class="result-subtitle">${event.source} • ${event.lokation}</div>
            </div>
            <button class="collab-btn">
              Anmod om samarbejde
            </button>
          </div>
          
          ${eventData?.beskrivelse ? `
            <p style="font-size: 14px; color: #6b7280; margin: 12px 0; line-height: 1.5;">
              ${eventData.beskrivelse}
            </p>
          ` : ''}
          
          <div class="result-details">
            ${eventData?.dato ? `
              <div class="result-detail-item">
                <div class="result-detail-label">Dato</div>
                <div class="result-detail-value">${eventData.dato}</div>
              </div>
            ` : ''}
            ${eventData?.tid ? `
              <div class="result-detail-item">
                <div class="result-detail-label">Tid</div>
                <div class="result-detail-value">${eventData.tid}</div>
              </div>
            ` : ''}
            ${eventData?.varighed ? `
              <div class="result-detail-item">
                <div class="result-detail-label">Varighed</div>
                <div class="result-detail-value">${eventData.varighed}</div>
              </div>
            ` : ''}
            
          </div>
        `;
        
        // Gem event data i card elementet
        card.dataset.eventData = JSON.stringify(event);
        
        // Find knappen i kortet
        const kollabKnap = card.querySelector('.collab-btn');
        
        // Når man klikker på knappen
        kollabKnap.addEventListener('click', function() {
          // Hent event-data fra kortet
          const eventData = JSON.parse(card.dataset.eventData);
          
          // Konverter til URL-format
          const dataForURL = encodeURIComponent(JSON.stringify(eventData));
          
          // Gå til kollab-siden
          window.location.href = `/kollab?event=${dataForURL}`;
        });
        
        container.appendChild(card);
      });
    }
    
    // Event listeners
    // når brugeren skriver i søgefeltet, søger vi efter events
    document.getElementById('search-input').addEventListener('input', searchEvents);
    // når brugeren vælger en kategori, søger vi efter events
    document.getElementById('category-filter').addEventListener('change', searchEvents);
    // når brugeren vælger en lokation, søger vi efter events
    document.getElementById('location-filter').addEventListener('change', searchEvents);
    
    // Logout funktion
    async function logout() {
      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        const result = await response.json();
        
        if (result.success) {
          window.location.href = '/';
        }
      } catch (error) {
        console.error('Fejl ved logout:', error);
      }
    }

    //Finder det event der er trykket på under "Oplevelser", altså det event der vil samarbejdes omkring
    async function findSamarbejdeEvent() {
      try {
        // Find info på vært der er logget ind.
        const hvemErLoggetInd = await fetch('/api/auth/me', {
          credentials: 'include'
        });
        const hvemErLoggetIndResultat = await hvemErLoggetInd.json();
        
        // Find navn på vært der er logget ind
        const loggetIndHostNavn = hvemErLoggetIndResultat.host.navn;
        
        //Find alle events som denne vært har(Vært der er logget ind)
        const response = await fetch('/services/hostEvents?host=' + loggetIndHostNavn);
        const HostOgEventData = await response.json();

        console.log("*******Events for host der er logget ind******");
        console.log(HostOgEventData);

        //Find det event der er blivet klikket på i oplevelser
        const params = new URLSearchParams(window.location.search);
        const clickedEventId = params.get("eventID");

        console.log("********ClickedEvent.ID*********")
        console.log(clickedEventId);

        let giventEventInfo = HostOgEventData.data.events[0][clickedEventId-1];
        //console.log("****EventInfo*****");
        //console.log(giventEventInfo);

        let test = document.getElementById("eventInfo");
        test.innerHTML = "Event id: " + clickedEventId + ", Event titel: " + giventEventInfo.titel;

      } catch (error) {
        console.error('Fejl:', error);
      }
    };

    
    // Load events når siden loader
    window.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      }
      loadAllEvents();
      findSamarbejdeEvent();
    });
  </script>
</body>
</html>

